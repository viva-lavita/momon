## Склерозник

`TODO`: Все фразы реализованы на английском, вынесены в constants.py каждого модуля. При желании можно бескровно подключить автоперевод.

#### Как работает аутентификация

1. Адрес по которому можно получить токен - указана в переменной oauth2_scheme.
2. В openapi можно через форму в замке авторизоваться по логину и паролю, приложение само сходит по нужному адресу, возьмет токен и запомнит его. Автоирзовываться нужно лишь раз - через эту форму.
3. В проде данные формы (логин-пароль) отправляются по этому адресу, стандартно берется токен, фронт сам его хранит. Токен сейчас действителен 8 дней. Изменения стандартно, через env и конфиг.
4. Адреса:
    - `/auth/test-token` - для тестирования авторизации, возвращает текущего юзера, если он авторизован и 401 если нет.
    - `/auth/password-recovery/{email}` - отправка сообщения с восстановлением доступа по эмейл. Настроено. Токен из письма действителен сейчас 48 часов. Ссылка отправляет на сервер фронта, токеном в параметрах.
    - `/auth/reset-password/` -  смена пароля для аутентифицированного юзера. Тело - токен и новый пароль.
    - `/auth/password-recovery-html-content/{email}` - возвращает шаблон для смены пароля.


#### Как пользоваться шаблонами для почты
Шаблоны электронной почты находятся в каталоге ./backend/src/email-templates/. Здесь есть две директории: build и src. Каталог src содержит исходные файлы, которые используются для создания окончательных шаблонов электронной почты. Каталог build содержит конечные шаблоны электронной почты, которые используются приложением.

Прежде чем продолжить, убедитесь, что расширение MJML установлено в вашем VS Code.

После установки расширения MJML вы можете создать новый шаблон электронной почты в каталоге src. После создания нового шаблона электронной почты и открытия файла .mjml в редакторе, откройте палитру команд с помощью Ctrl+Shift+P и найдите MJML: Export to HTML. Это преобразует файл .mjml в файл .html, и теперь вы можете сохранить его в директории сборки.


#### Полезные команды и информация:

Запуск локально:

```bash
uv run src/main.py
```

openapi по адресу:

```str
http://127.0.0.1:8000/api/v1/docs
```

Дебаг включается-выключается в зависимости от режима см. последние строки в src/config.py
Варианты: LOCAL, STAGING, PRODUCTION, TESTING.

Используется одели данных sqlmodel(от создателя fastapi), поэтому отличие моделей базы данных от схем пайдентик в параметре table=True. Конкретно тут также используется наследование моделей бд от схем, пример:

```python
# пайдентик схема
class UserBase(SQLModel):
    username: str = Field(unique=True, index=True, max_length=255)
    email: EmailStr = Field(unique=True, index=True, max_length=255)
    is_active: bool = True
    is_superuser: bool = False
    full_name: str | None = Field(default=None, max_length=255)


# модель бд
class User(UserBase, AsyncAttrs, table=True):
    id: uuid.UUID = Field(default_factory=uuid.uuid4, primary_key=True)
    hashed_password: str
    role_id: uuid.UUID = Field(foreign_key="role.id", nullable=False, ondelete="RESTRICT")
    role: "Role" = Relationship(back_populates="users", sa_relationship_kwargs={"lazy": "selectin"})
```

Т.е. наследуем от схемы, пишем table=True и расширяем.
